<div class="container pt-0">
  <!-- Filtros -->
  <div class="row mt-0 sticky-section border-0 rounded-4 p-2 mt-0 shadow mb-3">
    <div class="row">
      <!-- Filtro de fechas -->
      <div class="col d-flex gap-3">
        <div class="col-3">
          <input
            type="month"
            class="form-control border-1 bg-light"
            [(ngModel)]="periodFrom"
            (ngModelChange)="applyFilters()"
            [max]="periodTo"
            [min]="minDateFrom"
          />
        </div>
        <div class="col-3">
          <input
            type="month"
            class="form-control border-1 bg-light"
            [(ngModel)]="periodTo"
            (ngModelChange)="applyFilters()"
            [min]="periodFrom"
            [max]="getCurrentYearMonth()" 
          />
        </div>
   
      </div>
      <!-- Botones de exportar -->
      <div class="col-auto d-flex gap-2 ms-auto">
        <button
          class="btn btn-primary filterbutton"
          data-bs-toggle="modal"
          title="Filtros Avanzados"
          data-bs-target="#filtrosAvanzados"
        >
          <i class="bi bi-funnel-fill"></i>
        </button>
        <button
          type="button"
          class="btn btn-secondary bi bi-trash filterbutton"
          title="Limpiar Filtros"
          (click)="resetFilters()"
        ></button>
      </div>
    </div>
  </div>
  <div class="modal fade" id="filtrosAvanzados" tabindex="-1" aria-labelledby="filtrosAvanzadosLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filtrosAvanzadosLabel">Filtros Avanzados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="input-group-with-label"></div>
          <label for="chartType" class="form-label">Tipo de Gráfico</label>
          <select id="chartType" class="form-select" [(ngModel)]="chartType" (change)="onChartTypeChange()">
            <option value="ingresos">Ingresos</option>
            <option value="egresos">Egresos</option>
            <option value="total">Ambos</option>
          </select>
          
        </div>
        <div class="col">
          <div class="input-group-with-label">
            <div class="input-group">
              <ng-select [items]="availableUserTypes" [multiple]="true" [closeOnSelect]="false" [searchable]="true"
                bindLabel="label" bindValue="value" [clearable]="false" [(ngModel)]="selectedUserTypes"
                (change)="applyFilters()"
                [placeholder]="selectedUserTypes.length ? '' : 'Seleccionar tipo de ingresante'">
                <ng-template ng-multi-label-tmp let-items="items">
                  <div *ngIf="items.length > 0">({{items.length}}) Seleccionados</div>
                </ng-template>
                <ng-template ng-option-tmp let-item="item" let-item$="item$" let-index="index">
                  <input id="ingresante-{{index}}" type="checkbox" [checked]="item$.selected" />
                  <span class="ms-2">{{item.label}}</span>
                </ng-template>
              </ng-select>
            </div>
          </div>
        </div>



      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>

      </div>
    </div>
  </div>
</div>

  <!-- Grilla del dashboard -->
  <div class="row position-relative min-vh-75">
    <!-- Contenedor para cuando un grafico es grande -->
    <div class="container d-flex gap-3" *ngIf="status !== 0">

      <!-- KPIs para el gráfico de columnas cuando es grande-->
      <div class="col-md-4" *ngIf="status === 1">
        <div class="row">
          <div class="col">
            <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)">
              <div class="card-body">
                <h6 class="text-secondary b-2">
                  Cantidad de Ingresos del Mes Actual
                </h6>
                <h5 class="mb-0">{{this.showCurrentMonth()}} | {{ currentMonthAccessCount }}</h5>
              </div>
            </div>
          </div>
        </div>

        <!-- Promedio Mensual -->
         <div class="row">
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4  h-100 w-98" style="background-color: #e8f5e9">
              <div class="card-body position-relative p-0">
                <!-- Ícono en la fila superior alineado a la derecha -->
                <div class="d-flex justify-content-end mb-0 m-1 p-1">
                  <i
                    class="bi bi-star m-0 p-0"
                    style="font-size: 1rem; opacity: 0.8"
                  ></i>
                </div>
                
                <!-- Título centrado en la fila del medio -->
                <div class="text-center">
                  <h6 class="mb-1 fw-medium text-secondary">Mes con más Ingresos</h6>
                </div>
        
                <!-- Contador centrado en la fila inferior -->
                <div class="text-center">
                  <h6 class="mb-2">{{ monthEntry }} | {{ entriesCount }}</h6>
                </div>
              </div>
            </div>
          </div>
 
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4 h-100 w-98" style="background-color: #f8d7da">

              <div class="card-body position-relative p-0">
                <!-- Ícono en la fila superior alineado a la derecha -->
                <div class="d-flex justify-content-end mb-0 m-1 p-1">
                  <i
                    class="bi bi-star m-0 p-0"
                    style="font-size: 1rem; opacity: 0.8"
                  ></i>
                </div>
                
                <!-- Título centrado en la fila del medio -->
                <div class="text-center">
                  <h6 class="mb-1 fw-medium text-secondary">Mes con más Egresos</h6>
                </div>
        
                <!-- Contador centrado en la fila inferior -->
                <div class="text-center">
                  <h6 class="mb-2">{{ monthExit }} | {{ exitCount }}</h6>
                </div>
              </div>

            </div>
          </div>
        </div>
        <!-- FIN Promedio Mensual -->

        <!-- Total Ingresos anuales -->
        <div class="row">
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4 w-100" style="background-color: #d8ffedde">
              <div class="card-body p-0">
                <!-- Ícono en la fila superior alineado a la derecha -->
                <div class="d-flex justify-content-end mb-0 m-1 p-1">
                  <i
                    class="bi bi-box-arrow-right m-0 p-0"
                    style="font-size: 1rem; opacity: 0.8"
                  ></i>
                </div>
                
                <!-- Título centrado en la fila del medio -->
                <div class="text-center">
                  <h6 class="mb-1 fw-medium text-secondary">Total de Ingresos Anuales</h6>
                </div>
        
                <!-- Contador centrado en la fila inferior -->
                <div class="text-center">
                  <h5 class="mb-2">{{ totalAccesCount }}</h5>
                </div>
              </div>

            </div>
          </div>
        
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4 w-100" style="background-color: #f8d7da">
              <div class="card-body p-0">
                <!-- Ícono en la fila superior alineado a la derecha -->
                <div class="d-flex justify-content-end mb-0 m-1 p-1">
                  <i
                    class="bi bi-box-arrow-left m-0 p-0"
                    style="font-size: 1rem; opacity: 0.8"
                  ></i>
                </div>
                
                <!-- Título centrado en la fila del medio -->
                <div class="text-center">
                  <h6 class="mb-1 fw-medium text-secondary">Total de Egresos Anuales</h6>
                </div>
        
                <!-- Contador centrado en la fila inferior -->
                <div class="text-center">
                  <h5 class="mb-2">{{ totalExitCount }}</h5>
                </div>
              </div>

            </div>
          </div>
        </div>
        
      </div>
      <!-- Grafico de columnas -->
      <div class="col-md-8 mb-2" *ngIf="status === 1">
        <div class="card border-0 shadow-lg rounded-4 h-90 w-100">
          <div class="card-body p-0">
            <!--* Fila con título e ícono *-->
            <div class="d-flex align-items-center justify-content-between mb-0 m-1 p-1">
              <div class="flex-grow-1 text-center">
                <h4 class="mb-1">Cantidad de {{ capitalizeFirstLetter(chartType) }}</h4>
              </div>
              <button (click)="makeBig(0)" class="btn bi bi-arrow-left"></button>
            </div>
        
            <!--* Contador centrado en la fila inferior *-->
            <div class="text-center">
              <h6 class="mb-2 fw-medium pe-4">Rendimiento por cada día de la semana</h6>
            </div>
            <hr class="m-0">
            <google-chart
              [type]="columnChartType"
              [data]="columnChartData"
              [options]="columnChartOptions"
              class="expanded-chart-content"
              style="width: 100%; height: 287px"
            >
            </google-chart>
          </div>
        </div>
      </div>

      <!-- KPIs para el gráfico de pie cuando el grafico es grande -->
      <div class="col-md-4" *ngIf="status === 2">
        <!-- Método más usado -->
        <div class="row">
          <div class="col mb-3 me-0" *ngFor="let data of uniqueData">
            <div class="card border-0 shadow-lg mb-2 rounded-4 h-100 w-100"
              [ngClass]="{
                'bg-success': chartType === 'ingresos',
                'bg-danger': chartType === 'egresos'
              }">
              <div class="card-body position-relative">
                <div class="pe-5">
                  <h6 class="mb-3 p-0">
                    {{ translateRole(data.userType) }}
                  </h6>
                  <h5 class="mb-1 fw-semibold">{{ data.percentage }}%</h5>
                  <small class="text-muted mb-0">Total: {{ data.count }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grafico de pie -->
      <div class="col-8" *ngIf="status === 2">
        <!-- <div class="card border-0 shadow-lg">
          <ng-select
            [items]="availableUserTypes"
            [multiple]="true"
            [searchable]="false"
            bindLabel="label"
            bindValue="value"
            [(ngModel)]="selectedUserTypes"
            (change)="onUserTypeChange()"
            [placeholder]="selectedUserTypes && selectedUserTypes.length ? '' : 'Seleccionar tipos de usuario'">
            <ng-template ng-multi-label-tmp let-items="items">
              <div *ngIf="items.length > 0">
                {{ items.length }} tipo(s) seleccionado(s)
              </div>
            </ng-template>
            <ng-template ng-option-tmp let-item="item" let-index="index">
              <input
                [id]="'item-' + index"
                type="checkbox"
                [checked]="selectedUserTypes.includes(item.value)"
              />
              <span class="ms-2">{{ item.label }}</span>
            </ng-template>
          </ng-select>
        </div> -->

        <div class="ms-1 card border-0 shadow-lg rounded-4">
          <div class="card-body p-0">

            <!--* Fila con título e ícono *-->
            <div class="d-flex align-items-center justify-content-between mb-0 m-1 p-1">
              <div class="flex-grow-1 text-center">
                <h4 class="mb-1">Comparación de {{ capitalizeFirstLetter(chartType) }} según Tipos de Ingresante</h4>
              </div>
              <button (click)="makeBig(0)" class="btn bi bi-arrow-left"></button>
            </div>

            <hr class="mt-1 mb-0">
            <div id="chartContainer mt-0">
              <google-chart class="mt-0" style="width: 700px; height: 338px" [type]="barChartType" [data]="barChartData" [options]="barChartOptions">
              </google-chart>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- KPIs generales, cuando se ven todos los graficos juntos -->
    <div class="col-md-2" *ngIf="status === 0">
      <!-- KPI General para Columnas -->
      <div class="row">
        <div class="col">
          <div
            class="card border-0 shadow-lg rounded-4 mb-3 p-0 hover-scale"
            (click)="makeBig(1)"
            style="background-color: #d4edda"
          >
            <div class="card-body p-0">
              <!-- Ícono en la fila superior alineado a la derecha -->
              <div class="d-flex justify-content-end mb-0 m-1 p-1">
                <i
                  class="bi bi-box-arrow-right m-0 p-0"
                  style="font-size: 1rem; opacity: 0.8"
                ></i>
              </div>
              
              <!-- Título centrado en la fila del medio -->
              <div class="text-center">
                <h6 class="mb-1 fw-medium text-secondary">Ingresos diarios</h6>
              </div>
      
              <!-- Contador centrado en la fila inferior -->
              <div class="text-center">
                <h5 class="mb-2">{{ currentMonthAccessCount }}</h5>
              </div>
            </div>
          </div>
        </div>
      </div>
      

      <!-- KPI General para Columnas -->
      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)" style="background-color: #f8d7da">
              <div class="card-body p-0">
                <!-- Ícono en la fila superior alineado a la derecha -->
                <div class="d-flex align-items-top justify-content-end mb-0 m-1 p-1">
                  <i
                    class="bi bi-box-arrow-left"
                    style="font-size: 1rem; opacity: 0.8"
                  ></i>
                </div>
                
                <!-- Título centrado en la fila del medio -->
                <div class="text-center">
                  <h6 class="mb-1 fw-medium text-secondary">Egresos diarios</h6>
                </div>
        
                <!-- Contador centrado en la fila inferior -->
                <div class="text-center">
                  <h5 class="mb-2">{{ currentMonthExitCount }}</h5>
                </div>
              </div>
          </div>
        </div>
      </div>

      <!-- KPI General para ingresos pico por día de la semana -->
      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)">
            <div class="card-body p-0">
              <!-- Ícono en la fila superior alineado a la derecha -->
              <div class="d-flex align-items-top justify-content-end mb-0 m-1 p-1">
                <i
                  class="bi bi-box-arrow-right"
                  style="font-size: 1rem; opacity: 0.8"
                ></i>
              </div>
              
              <!-- Título centrado en la fila del medio -->
              <div class="text-center">
                <h6 class="mb-1 fw-medium text-secondary">Día con más Ingresos esta Semana</h6>
              </div>
      
              <!-- Contador centrado en la fila inferior -->
              <div class="text-center">
                @if(accessCount > 0){
                  <h5 class="mb-2 fw-medium">{{ capitalizeFirstLetter(dayWithMostAccesses) }} | {{ accessCount }}</h5>
                } @else {
                  <h4 class="mb-2"><i class="bi bi-dash-lg"></i></h4>
                }
              </div>

            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)">
            <div class="card-body p-0">
              <!-- Ícono en la fila superior alineado a la derecha -->
              <div class="d-flex align-items-top justify-content-end mb-0 m-1 p-1">
                <i
                  class="bi bi-box-arrow-left"
                  style="font-size: 1rem; opacity: 0.8"
                ></i>
              </div>
              
              <!-- Título centrado en la fila del medio -->
              <div class="text-center">
                <h6 class="mb-1 fw-medium text-secondary">Día con más Egresos esta Semana</h6>
              </div>
      
              <!-- Contador centrado en la fila inferior -->
              <div class="text-center">
                @if(accessCount > 0){
                  <h5 class="mb-2 fw-medium">{{ capitalizeFirstLetter(dayWithMostExits) }} | {{ exitsCountPeak }}</h5>
                } @else {
                  <h4 class="mb-2"><i class="bi bi-dash-lg"></i></h4>
                }
              </div>

            </div>
          </div>
        </div>
      </div>

 

      <!-- KPI para vecino con más autorizaciones -->
      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="redirect(redirectKpis.neighborAuthorizations, 'neighborAuthorizations')">
            <div class="card-body p-0 mb-2">
              <!-- Ícono en la fila superior alineado a la derecha -->
              <div class="d-flex align-items-top justify-content-end mb-0 m-1 p-1">
                <i
                  class="bi bi-house"
                  style="font-size: 1rem; opacity: 0.8"
                ></i>
              </div>
              
              <!-- Título centrado en la fila del medio -->
              <div class="text-center">
                <h6 class="mb-1 fw-medium text-secondary">Vecino con más personas autorizadas</h6>
              </div>
      
              <!-- Contador centrado en la fila inferior -->
              <div class="text-center mb-2">
                @if(redirectKpis.neighborAuthorizations && redirectKpis.neighborAuthorizations.count){
                  <h5 class="fw-medium">{{ redirectKpis.neighborAuthorizations.name }} | {{ redirectKpis.neighborAuthorizations.count }}</h5>
                } @else {
                  <h4 class=""><i class="bi bi-dash-lg"></i></h4>
                }
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>




    <!-- Gráfico de columnas -->
    <div class="col-12 col-lg-5" *ngIf="status === 0" style="height: 100%">

      <div class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale" (click)="makeBig(2)">
        <div class="card-body">
          <div class="d-flex text-center justify-content-center align-items-center mb-0">
            <h4 class="card-title m-0">Cantidad de {{ capitalizeFirstLetter(chartType) }}</h4>
          </div>
          <div class="d-flex text-center justify-content-center align-items-center mb-0">
            <h6 class="">Según Tipo de Ingresante</h6>
          </div>
          <hr class="mt-1 mb-3">
          <google-chart 
            style="width: 100%; height: 400px"
            [type]="barChartType"
            [data]="barChartData"
            [options]="barChartOptions"
            [height]="barChartOptions.height">
          </google-chart>
        </div>
      </div>

         <!-- KPIs de guardias movidos aquí -->
        <div class="row mt-3">
          <!-- KPI para guardia con más ingresos -->
          <div class="col-6 mt-0" *ngIf="chartType !== 'egresos'">
            <div class="card border-0 shadow-lg rounded-4 mb-4 hover-scale" (click)="redirect(redirectKpis.guardEntries, 'guardEntries')">
              <div class="card-body p-0 mb-2">
                <!-- Ícono en la fila superior alineado a la derecha -->
                <div class="d-flex align-items-top justify-content-end mb-0 m-1 p-1">
                  <i
                    class="bi bi-house-lock"
                    style="font-size: 1rem; opacity: 0.8"
                  ></i>
                </div>
                <!-- Título centrado en la fila del medio -->
                <div class="text-center">
                  <h6 class="mb-1 fw-medium text-secondary">Guardia con mayor registro de Ingresos</h6>
                </div>
                <!-- Contador centrado en la fila inferior -->
                <div class="text-center mb-2">
                    <h5 class="fw-medium">{{ redirectKpis.guardEntries.name }} | {{ redirectKpis.guardEntries.count }}</h5>
                </div>
              </div>
            </div>
          </div>
          
          <!--* KPI para guardia con más egresos *-->
          <div class="col-6 mt-0" *ngIf="chartType !== 'ingresos'">
            <div class="card border-0 shadow-lg rounded-4 mb-4 hover-scale" (click)="redirect(redirectKpis.guardExits, 'guardExits')">
              <div class="card-body p-0 mb-2">
                <!-- Ícono en la fila superior alineado a la derecha -->
                <div class="d-flex align-items-top justify-content-end mb-0 m-1 p-1">
                  <i
                    class="bi bi-house-lock"
                    style="font-size: 1rem; opacity: 0.8"
                  ></i>
                </div>
                <!-- Título centrado en la fila del medio -->
                <div class="text-center">
                  <h6 class="mb-1 fw-medium text-secondary">Guardia con mayor registro de Egresos</h6>
                </div>
                <!-- Contador centrado en la fila inferior -->
                <div class="text-center mb-2">
                    <h5 class="fw-medium">{{ redirectKpis.guardExits.name }} | {{ redirectKpis.guardExits.count }}</h5>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
    <!-- Gráfico top 5 -->
    <div class="col-12 col-lg-5" *ngIf="status === 0">
      <div class="mb-3">
        <!--  -->
        <div class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale" (click)="makeBig(1)">
          <div class="card-body">
            <div class="d-flex justify-content-center text-center align-items-center mt-2 mb-0">
              <h4 class="card-title m-0">Comparación de {{ capitalizeFirstLetter(chartType) }}</h4>
            </div>
            <hr class="mb-0 mt-4">
            <google-chart class="mt-0"
              style="width: 100%; height: 260px"
              [type]="columnChartType"
              [data]="columnChartData"
              [options]="columnChartOptions">
            </google-chart>
          </div>
        </div>
        <!--  -->
        <div class="mt-3">
          <div class="card border-0 shadow-lg rounded-4 transition-all hover-scale" (click)="makeBig(2)">
            <div class="card-body">
              <div class="d-flex justify-content-center align-items-center mb-0">
                <div>
                  <h4 class="card-title fw-semibold mb-1 text-center">TOP 5</h4>
                  <h6 class="fw-medium">Ingresantes con más Ingresos/Egresos</h6>
                </div>
              </div>

              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Ingresos</th>
                    <th>Egresos</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let user of topUser">
                    <td>{{ user[0] }}</td>
                    <td>{{ translateRole(user[1]) }}</td>
                    <td>{{ user[2] }}</td>
                    <td>{{ user[3] }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de info -->
<div class="modal fade" id="infoModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          Información del Dashboard
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>
          Bienvenido al Dashboard de Accesos. Este panel te permite:
        </p>
        <ul>
          <li>
            Visualizar estadísticas de Ingresos/Egresos en tiempo real,
            incluyendo gráficos y tablas detalladas.
          </li>
          <li>Generar reportes personalizados basados en fechas y años.</li>
          <li>
            Acceder a un historial completo de tipos de personas que ingresan y
            más.
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>